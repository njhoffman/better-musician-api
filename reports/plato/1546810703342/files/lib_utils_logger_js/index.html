<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - lib/utils/logger.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>lib/utils/logger.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">69.41</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">147</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">35.97</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.60</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">const uuid = require(&#039;uuid&#039;);
const _ = require(&#039;lodash&#039;);
const bunyan = require(&#039;bunyan&#039;);
const { serializers } = require(&#039;./logger.utils&#039;);

let loggerInstance;

const defaultName = process.env.PWD ? process.env.PWD.split(&#039;/&#039;).pop() : &#039;app&#039;;

const { __APP_NAME__, __SUPPRESS_LOGS__ } = process.env;
const appName = __APP_NAME__ || global.__APP_NAME__ || defaultName;
const suppressLogs = __SUPPRESS_LOGS__ || global.__SUPPRESS_LOGS__ || false;

const logConfig = {
  streams: [{
    stream: process.stdout,
    level: &#039;trace&#039;
  }],
  serializers: bunyan.stdSerializers
};

const preprocess = (log, level, ...message) =&gt; {
  // add global properties

  const msg = _.cloneDeep(message);
  if (_.isObjectLike(msg[0])) {
    msg[0]._logId = uuid.v4();
  } else {
    msg.unshift({
      _logId: uuid.v4()
    });
  }

  // add property to indicate to log viewer what level to filter object
  const logLevels = {
    silly : 7,
    trace : 6,
    debug : 5,
    info  : 4,
    warn  : 3,
    error : 2,
    fatal : 1
  };

  _.keys(logLevels).forEach(key =&gt; {
    if (_.has(msg[0], `_${key}`)) {
      const msgObj = _.cloneDeep(msg[0][`_${key}`]);
      msgObj._log_level = logLevels[key];
      _.merge(msg[0], msgObj);
      delete msg[0][`_${key}`];
    }
  });

  // apply serializers
  if (_.isObjectLike(msg[0])) {
    _.each(_.keys(msg[0]), (key) =&gt; {
      if (_.has(serializers, key)) {
        const obj = _.cloneDeep(msg[0][key]);
        _.merge(msg[0], serializers[key](obj));
      }
    });
  }

  if (!suppressLogs) {
    log[level](...msg);
  }
};

const timers = {};
const timerStart = (name, desc) =&gt; {
  if (!name) {
    loggerInstance.warn(&#039;need to initialize timer with a name/id&#039;);
    return;
  }
  timers[name] = { desc: desc || name, start: new Date().getTime() };
};

const timerShow = (name) =&gt; {
  if (!_.has(timers, name)) {
    loggerInstance.warn(`timer: ${name} not found`);
    return;
  }
  let fmtTime = new Date().getTime() - timers[name].start;
  fmtTime = fmtTime &gt; 1000 ? `${(fmtTime / 1000).toFixed(1)}s` : `${fmtTime}ms`;
  loggerInstance.info({ color: &#039;logTimer&#039; }, `%${name}: ${fmtTime}%`);
};

const timerEnd = (name) =&gt; {
  timerShow(name);
  delete timers[name];
};

const createInstance = (name, log) =&gt; ({
  name,
  _dbg:    preprocess.bind(undefined, log, &#039;fatal&#039;),
  silly:   preprocess.bind(undefined, log, &#039;silly&#039;),
  trace:   preprocess.bind(undefined, log, &#039;trace&#039;),
  debug:   preprocess.bind(undefined, log, &#039;debug&#039;),
  info:    preprocess.bind(undefined, log, &#039;info&#039;),
  warn:    preprocess.bind(undefined, log, &#039;warn&#039;),
  error:   preprocess.bind(undefined, log, &#039;error&#039;),
  fatal:   preprocess.bind(undefined, log, &#039;fatal&#039;),
  streams: log.streams,
  parent:  log,
  timerStart,
  timerEnd,
  timerShow
});


const createLogger = (name, childParams, extra) =&gt; {
  // TODO: fork bunyan and handle this in there
  const instanceConfig = { ...logConfig, name };
  const logParent = bunyan.createLogger(instanceConfig).child(childParams);
  const instance = createInstance(name, logParent);
  // instance.child = (args) =&gt; logger(args.subsystem, _.merge(extra, args));
  instance.child = (args) =&gt; {
    const child = createInstance(name, _.merge(extra, args));
    return child;
  };
  return instance;
};

const logger = (subsystem, extra = {}) =&gt; {
  const childParams = _.merge(extra, { subsystem });

  if (loggerInstance) {
    loggerInstance = createInstance(loggerInstance.name, loggerInstance.parent.child(childParams));
    loggerInstance.child = (args) =&gt; logger(args.subsystem || subsystem, _.merge(extra, args));
    return loggerInstance;
  }

  loggerInstance = createLogger(appName, childParams, extra);
  loggerInstance.child = (args) =&gt; logger(args.subsystem || subsystem, _.merge(extra, args));
  loggerInstance.debug(
    { ...(_.omit(extra, &#039;subsystem&#039;)) },
    `loaded logger configuration for ${appName} (${subsystem})`
  );
  return loggerInstance;
};

// returns singleton if set, else returns new instance and setings singleton
module.exports = logger;

// returns new instance and does not set singleton
module.exports.initLogger = (name = appName) =&gt; (subsystem, extra) =&gt; createLogger(name, { subsystem }, extra);
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
